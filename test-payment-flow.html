<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payment Flow</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <h1>Test Payment Flow</h1>
    <button onclick="testPayment()">Test Payment</button>
    <div id="result"></div>

    <script>
        function log(message) {
            const result = document.getElementById('result');
            result.innerHTML += '<p>' + message + '</p>';
            console.log(message);
        }

        async function testPayment() {
            try {
                log('Starting payment test...');
                
                // Step 1: Create order
                log('Creating Razorpay order...');
                const orderResponse = await fetch('/api/subscriptions/razorpay/order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        studentId: '68b93ceb7a29319f4c55b956',
                        alumniId: '68b91f857a29319f4c55b486',
                        subscriptionType: 'monthly'
                    })
                });

                if (!orderResponse.ok) {
                    const errorData = await orderResponse.json();
                    log('Order creation failed: ' + JSON.stringify(errorData));
                    return;
                }

                const orderData = await orderResponse.json();
                log('Order created successfully: ' + orderData.order.id);

                // Step 2: Open Razorpay modal
                const options = {
                    key: orderData.key,
                    amount: orderData.order.amount,
                    currency: orderData.order.currency,
                    name: 'AlumniHive',
                    description: 'Test Payment',
                    order_id: orderData.order.id,
                    prefill: {
                        name: 'Test User',
                        email: 'test@example.com',
                        contact: '9999999999'
                    },
                    handler: async function (response) {
                        log('Payment successful! Verifying payment...');
                        log('Payment ID: ' + response.razorpay_payment_id);
                        log('Order ID: ' + response.razorpay_order_id);
                        log('Signature: ' + response.razorpay_signature);
                        
                        // Step 3: Verify payment
                        try {
                            const verifyResponse = await fetch('/api/subscriptions/razorpay/verify', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    orderId: response.razorpay_order_id,
                                    paymentId: response.razorpay_payment_id,
                                    signature: response.razorpay_signature,
                                    studentId: '68b93ceb7a29319f4c55b956',
                                    alumniId: '68b91f857a29319f4c55b486',
                                    subscriptionType: 'monthly'
                                })
                            });

                            if (verifyResponse.ok) {
                                const verifyData = await verifyResponse.json();
                                log('Payment verification successful!');
                                log('Subscription created: ' + verifyData.subscription.id);
                            } else {
                                const errorData = await verifyResponse.json();
                                log('Payment verification failed: ' + JSON.stringify(errorData));
                            }
                        } catch (error) {
                            log('Verification error: ' + error.message);
                        }
                    },
                    modal: {
                        ondismiss: function() {
                            log('Payment modal dismissed');
                        }
                    }
                };

                log('Opening Razorpay modal...');
                const razorpay = new Razorpay(options);
                razorpay.open();

            } catch (error) {
                log('Error: ' + error.message);
            }
        }
    </script>
</body>
</html>
